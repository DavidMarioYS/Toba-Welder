<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Toba Welder - Quotation System</title>
    <!-- Alternative CDN Sources with Fallback -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js" 
            integrity="sha512-BNaRQnYJYiPSqHHDb58B0yaPfCu+Wgds8Gp/gU33kqBtgNS4tSPHuGibyoeqMV/TJlSKda6FXzoEyYGjTe+vXA==" 
            crossorigin="anonymous" 
            referrerpolicy="no-referrer"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js" 
            integrity="sha512-qZvrmS2ekKPF2mSznTQsxqPgnpkI4DNTlrdUmTzrDgektczlKNRRhy5X5AAOnx5S09ydFYWWNSfcEqDTTHgtNA==" 
            crossorigin="anonymous" 
            referrerpolicy="no-referrer"></script>
    <!-- Fallback to unpkg if cdnjs fails -->
    <script>
        window.addEventListener('load', function() {
            // Check and load fallback if needed
            if (!window.html2canvas) {
                console.log('Loading html2canvas fallback...');
                var script = document.createElement('script');
                script.src = 'https://unpkg.com/html2canvas@1.4.1/dist/html2canvas.min.js';
                document.head.appendChild(script);
            }
            if (!window.jspdf) {
                console.log('Loading jsPDF fallback...');
                var script = document.createElement('script');
                script.src = 'https://unpkg.com/jspdf@2.5.1/dist/jspdf.umd.min.js';
                document.head.appendChild(script);
            }
        });
    </script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #1a1a1a 0%, #2d2d2d 100%);
            min-height: 100vh;
            padding: 20px;
            position: relative;
        }
        
        body::before {
            content: '';
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-image: 
                repeating-linear-gradient(45deg, transparent, transparent 35px, rgba(255, 140, 0, 0.03) 35px, rgba(255, 140, 0, 0.03) 70px);
            pointer-events: none;
            z-index: 0;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            position: relative;
            z-index: 1;
        }

        .header {
            text-align: center;
            color: white;
            margin-bottom: 30px;
            animation: fadeInDown 1s ease;
            position: relative;
            z-index: 1;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 20px;
        }
        
        .logo-container {
            width: 80px;
            height: 80px;
            position: relative;
            animation: pulse 2s infinite;
        }
        
        .logo-img {
            width: 100%;
            height: 100%;
            object-fit: contain;
            filter: drop-shadow(0 0 10px rgba(255, 140, 0, 0.5));
        }
        
        .star-logo {
            width: 100%;
            height: 100%;
            position: relative;
        }
        
        .star {
            fill: #1a1a1a;
            stroke: #ff8c00;
            stroke-width: 2;
        }
        
        .welder-icon {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            width: 60%;
            height: 60%;
        }
        
        .header-text {
            text-align: left;
        }

        .header h1 {
            font-size: 2.5em;
            margin-bottom: 5px;
            text-shadow: 3px 3px 6px rgba(0,0,0,0.5);
            background: linear-gradient(135deg, #ff8c00 0%, #ffffff 50%, #007bff 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            font-weight: 900;
            letter-spacing: 2px;
        }
        
        .header p {
            color: #ff8c00;
            font-size: 1.1em;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.5);
        }

        .main-wrapper {
            display: grid;
            gap: 30px;
            animation: fadeIn 1s ease;
            transition: all 0.5s ease;
        }

        .main-wrapper.form-only {
            grid-template-columns: 1fr;
            max-width: 900px;
            margin: 0 auto;
        }

        .main-wrapper.with-preview {
            grid-template-columns: minmax(450px, 1fr) minmax(500px, 1.2fr);
            max-width: 100%;
        }

        @media (max-width: 1200px) {
            .main-wrapper.with-preview {
                grid-template-columns: 1fr;
            }
        }

        .form-section, .preview-section {
            background: white;
            border-radius: 15px;
            padding: 30px;
            box-shadow: 
                0 20px 40px rgba(0,0,0,0.2),
                0 0 0 1px rgba(255,140,0,0.1);
            position: relative;
            overflow-x: auto;
            overflow-y: hidden;
        }
        
        .form-section::before, .preview-section::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 3px;
            background: linear-gradient(90deg, #ff8c00 0%, #007bff 50%, #ff8c00 100%);
        }

        .preview-section {
            display: none;
            animation: slideIn 0.5s ease;
        }

        .preview-section.active {
            display: block;
        }

        .preview-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            padding-bottom: 10px;
            border-bottom: 3px solid #ff8c00;
        }

        .close-preview {
            background: linear-gradient(135deg, #ff6b6b 0%, #ee5a6f 100%);
            color: white;
            border: none;
            width: 40px;
            height: 40px;
            border-radius: 50%;
            cursor: pointer;
            font-size: 20px;
            font-weight: bold;
            transition: all 0.3s;
            display: flex;
            align-items: center;
            justify-content: center;
            box-shadow: 0 4px 10px rgba(255, 107, 107, 0.3);
        }

        .close-preview:hover {
            transform: rotate(90deg) scale(1.1);
            box-shadow: 0 6px 15px rgba(255, 107, 107, 0.4);
        }

        @keyframes slideIn {
            from {
                opacity: 0;
                transform: translateX(20px);
            }
            to {
                opacity: 1;
                transform: translateX(0);
            }
        }

        .form-section h2, .preview-section h2 {
            color: #1a1a1a;
            font-size: 22px;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .form-group {
            margin-bottom: 25px;
            animation: fadeIn 0.5s ease;
        }

        .form-group label {
            display: block;
            color: #333;
            font-weight: 600;
            margin-bottom: 10px;
            font-size: 15px;
            letter-spacing: 0.3px;
        }

        .form-group input, .form-group textarea {
            width: 100%;
            padding: 14px;
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            font-size: 14px;
            transition: all 0.3s;
            background: white;
        }

        .form-group input:hover, .form-group textarea:hover {
            border-color: #ccc;
        }

        .form-group input:focus, .form-group textarea:focus {
            outline: none;
            border-color: #ff8c00;
            box-shadow: 0 0 0 4px rgba(255, 140, 0, 0.1);
            background: #fffbf7;
        }

        .form-group textarea {
            resize: vertical;
            min-height: 80px;
        }

        .nomor-group {
            display: grid;
            grid-template-columns: 3fr 1fr;
            gap: 10px;
            align-items: end;
        }

        .items-container {
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            padding: 20px;
            margin-bottom: 20px;
            background: linear-gradient(135deg, #f9f9f9 0%, #f5f5f5 100%);
            min-width: 600px;
            overflow-x: auto;
        }
        
        .items-table {
            width: 100%;
            min-width: 550px;
        }

        .item-header {
            display: grid;
            grid-template-columns: minmax(200px, 2fr) 80px minmax(100px, 1fr) minmax(100px, 1fr) 90px;
            gap: 15px;
            margin-bottom: 12px;
            padding: 10px 5px;
            background: rgba(255, 140, 0, 0.05);
            border-radius: 6px;
            font-size: 12px;
            color: #333;
            font-weight: 700;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .item-header > div {
            display: flex;
            align-items: center;
            padding: 0 8px;
        }

        @keyframes slideInFromBottom {
            from {
                opacity: 0;
                transform: translateY(20px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .item-row {
            display: grid;
            grid-template-columns: minmax(200px, 2fr) 80px minmax(100px, 1fr) minmax(100px, 1fr) 90px;
            gap: 15px;
            margin-bottom: 12px;
            align-items: center;
            padding: 5px;
            background: white;
            border-radius: 6px;
            transition: all 0.2s;
            animation: slideInFromBottom 0.3s ease;
        }

        .item-row:hover {
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }

        .item-row input {
            width: 100%;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 6px;
            font-size: 14px;
            transition: all 0.2s;
        }

        .item-row input:focus {
            border-color: #ff8c00;
            box-shadow: 0 0 0 2px rgba(255, 140, 0, 0.1);
        }

        .item-row input[readonly] {
            background: #f8f8f8;
            cursor: not-allowed;
        }

        .btn {
            padding: 14px 28px;
            border: none;
            border-radius: 8px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
            margin: 5px;
            position: relative;
            overflow: hidden;
        }

        .btn::before {
            content: '';
            position: absolute;
            top: 50%;
            left: 50%;
            width: 0;
            height: 0;
            border-radius: 50%;
            background: rgba(255, 255, 255, 0.5);
            transform: translate(-50%, -50%);
            transition: width 0.6s, height 0.6s;
        }

        .btn:active::before {
            width: 300px;
            height: 300px;
        }

        .btn-primary {
            background: linear-gradient(135deg, #ff8c00 0%, #ff6347 100%);
            color: white;
            box-shadow: 0 4px 15px rgba(255, 140, 0, 0.3);
        }

        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(255, 140, 0, 0.4);
            background: linear-gradient(135deg, #ff9500 0%, #ff7357 100%);
        }
        
        .btn-success {
            background: linear-gradient(135deg, #007bff 0%, #0056b3 100%);
            color: white;
        }

        .btn-danger {
            background: linear-gradient(135deg, #ff6b6b 0%, #ee5a6f 100%);
            color: white;
        }

        .btn-add {
            background: linear-gradient(135deg, #4CAF50 0%, #45a049 100%);
            color: white;
            padding: 10px 20px;
            font-size: 14px;
            border-radius: 6px;
            margin-top: 10px;
            display: inline-flex;
            align-items: center;
            gap: 8px;
            box-shadow: 0 2px 4px rgba(76, 175, 80, 0.3);
        }

        .btn-add:hover {
            transform: translateY(-1px);
            box-shadow: 0 4px 8px rgba(76, 175, 80, 0.4);
        }

        .btn-remove {
            background: linear-gradient(135deg, #f44336 0%, #e53935 100%);
            color: white;
            padding: 8px 16px;
            font-size: 13px;
            border-radius: 6px;
            width: 100%;
            max-width: 90px;
            box-shadow: 0 2px 4px rgba(244, 67, 54, 0.3);
        }

        .btn-remove:hover {
            transform: translateY(-1px);
            box-shadow: 0 4px 8px rgba(244, 67, 54, 0.4);
        }

        .action-buttons {
            display: flex;
            justify-content: space-between;
            margin-top: 35px;
            padding-top: 25px;
            border-top: 2px solid #e0e0e0;
            gap: 15px;
        }

        .action-buttons .btn {
            flex: 1;
            max-width: 250px;
        }

        /* Compact Quotation Preview Styles for PDF */
        .kwitansi-preview {
            background: white;
            padding: 30px;
            border: 1px solid #333;
            border-radius: 4px;
            font-family: Arial, sans-serif;
            font-size: 11px;
            width: 100%;
            max-width: 600px;
            margin: 0 auto;
        }

        /* Hidden compact PDF template */
        .pdf-template {
            display: none;
            position: absolute;
            left: -9999px;
            width: 105mm; /* Half of A4 width */
            background: white;
            padding: 10mm;
            font-family: Arial, sans-serif;
        }

        .pdf-compact {
            font-size: 9pt;
            line-height: 1.3;
            color: #000;
        }

        .pdf-compact .pdf-header {
            text-align: center;
            border-bottom: 2px solid #333;
            padding-bottom: 8px;
            margin-bottom: 10px;
        }

        .pdf-compact .pdf-logo {
            width: 50px;
            height: 50px;
            margin: 0 auto 5px;
        }

        .pdf-compact .pdf-company {
            font-size: 14pt;
            font-weight: bold;
            margin-bottom: 2px;
        }

        .pdf-compact .pdf-subtitle {
            font-size: 8pt;
            color: #666;
            margin-bottom: 5px;
        }

        .pdf-compact .pdf-quote-no {
            font-size: 11pt;
            font-weight: bold;
            color: #ff8c00;
            margin-top: 5px;
        }

        .pdf-compact .pdf-info {
            display: flex;
            justify-content: space-between;
            margin-bottom: 10px;
            font-size: 8pt;
        }

        .pdf-compact .pdf-info-block {
            width: 48%;
        }

        .pdf-compact .pdf-info-block h4 {
            font-size: 9pt;
            border-bottom: 1px solid #ff8c00;
            padding-bottom: 2px;
            margin-bottom: 5px;
            text-transform: uppercase;
        }

        .pdf-compact .pdf-info-block p {
            margin: 2px 0;
            line-height: 1.2;
        }

        .pdf-compact table {
            width: 100%;
            border-collapse: collapse;
            margin-bottom: 10px;
            font-size: 8pt;
        }

        .pdf-compact th {
            background: #333;
            color: white;
            padding: 4px;
            text-align: left;
            font-size: 8pt;
        }

        .pdf-compact td {
            padding: 4px;
            border-bottom: 1px solid #e0e0e0;
        }

        .pdf-compact .pdf-notes {
            margin: 10px 0;
            padding: 8px;
            background: #f9f9f9;
            border-left: 3px solid #ff8c00;
            font-size: 8pt;
        }

        .pdf-compact .pdf-total {
            text-align: right;
            margin-top: 10px;
            padding: 8px;
            background: #f5f5f5;
            font-size: 9pt;
        }

        .pdf-compact .pdf-total-row {
            display: flex;
            justify-content: flex-end;
            margin: 2px 0;
        }

        .pdf-compact .pdf-total-label {
            margin-right: 10px;
        }

        .pdf-compact .pdf-grand-total {
            font-weight: bold;
            color: #ff8c00;
            border-top: 2px solid #ff8c00;
            padding-top: 5px;
            margin-top: 5px;
            font-size: 10pt;
        }

        .pdf-compact .pdf-payment {
            background: #e0e0e0;
            padding: 5px;
            margin-top: 10px;
            font-size: 7pt;
            text-align: center;
        }

        .pdf-compact .pdf-signatures {
            display: flex;
            justify-content: space-between;
            margin-top: 30px;
            font-size: 8pt;
        }

        .pdf-compact .pdf-signatures-single {
            display: flex;
            justify-content: center;
            margin-top: 25px;
            font-size: 8pt;
        }

        .pdf-compact .pdf-signature-box-center {
            text-align: center;
            width: 60%;
        }

        .pdf-compact .pdf-logo-stamp {
            margin: 0 auto 5px;
            display: flex;
            justify-content: center;
        }

        .pdf-compact .pdf-signature-box-center .pdf-signature-line {
            border-top: 1px solid #333;
            margin-top: 20px;
            padding-top: 3px;
            font-weight: bold;
        }

        .pdf-compact .pdf-signature-box {
            text-align: center;
            width: 45%;
        }

        .pdf-compact .pdf-signature-line {
            border-top: 1px solid #333;
            margin-top: 25px;
            padding-top: 3px;
        }

        .pdf-compact .pdf-footer {
            text-align: center;
            margin-top: 15px;
            font-size: 7pt;
            color: #666;
            font-style: italic;
        }

        .kwitansi-compact {
            padding: 20px;
            font-size: 10px;
            max-width: 400px;
        }

        .kwitansi-header {
            text-align: center;
            margin-bottom: 20px;
            border-bottom: 2px solid #333;
            padding-bottom: 15px;
        }

        .logo-preview {
            width: 80px;
            height: 80px;
            margin: 0 auto 10px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .logo-preview img {
            max-width: 100%;
            max-height: 100%;
            object-fit: contain;
        }

        .company-name {
            font-size: 20px;
            font-weight: bold;
            color: #222;
            margin-bottom: 3px;
        }

        .company-subtitle {
            font-size: 10px;
            color: #666;
        }

        .kwitansi-title {
            font-size: 16px;
            font-weight: bold;
            text-decoration: underline;
            margin: 10px 0;
            color: #ff8c00;
        }

        .kwitansi-info {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 15px;
            margin-bottom: 20px;
        }

        .info-block {
            padding: 10px;
            background: #f8f8f8;
            border-radius: 3px;
        }

        .info-block h4 {
            color: #333;
            margin-bottom: 8px;
            font-size: 11px;
            text-transform: uppercase;
            border-bottom: 1px solid #ff8c00;
            padding-bottom: 3px;
        }

        .info-block p {
            margin: 3px 0;
            color: #555;
            font-size: 10px;
            line-height: 1.4;
        }

        .kwitansi-items {
            margin: 20px 0;
        }

        .kwitansi-items table {
            width: 100%;
            border-collapse: collapse;
        }

        .kwitansi-items th {
            background: linear-gradient(135deg, #2d2d2d 0%, #1a1a1a 100%);
            color: #ff8c00;
            padding: 8px;
            text-align: left;
            font-size: 10px;
            border: 1px solid #ff8c00;
        }

        .kwitansi-items td {
            padding: 6px 8px;
            border-bottom: 1px solid #e0e0e0;
            font-size: 10px;
        }

        .kwitansi-items tr:hover {
            background: #f5f5f5;
        }

        .kwitansi-notes {
            margin: 15px 0;
            padding: 10px;
            background: #fffbf0;
            border-left: 3px solid #ffa500;
            border-radius: 3px;
        }

        .kwitansi-notes h5 {
            color: #333;
            margin-bottom: 5px;
            font-size: 10px;
            text-transform: uppercase;
        }

        .kwitansi-notes p {
            color: #666;
            font-size: 10px;
            line-height: 1.4;
        }

        .kwitansi-total {
            text-align: right;
            margin-top: 15px;
            padding: 15px;
            background: linear-gradient(135deg, #f5f5f5 0%, #e0e0e0 100%);
            border-radius: 5px;
        }

        .total-row {
            display: flex;
            justify-content: flex-end;
            margin: 3px 0;
            font-size: 11px;
        }

        .total-label {
            margin-right: 15px;
            font-weight: 600;
        }

        .total-amount {
            min-width: 100px;
            text-align: right;
        }

        .grand-total {
            font-size: 14px;
            font-weight: bold;
            color: #ff8c00;
            border-top: 2px solid #ff8c00;
            padding-top: 8px;
            margin-top: 8px;
        }

        .kwitansi-footer {
            margin-top: 30px;
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 40px;
        }

        .signature-box {
            text-align: center;
            padding-top: 10px;
        }

        .signature-line {
            border-top: 1px solid #333;
            margin-top: 40px;
            padding-top: 5px;
            font-size: 10px;
        }

        .account-info {
            background: #f0f0f0;
            padding: 10px;
            border-radius: 3px;
            margin-top: 15px;
            font-size: 9px;
        }

        .account-info h5 {
            color: #333;
            margin-bottom: 5px;
            font-size: 10px;
        }

        .no-print {
            margin-top: 20px;
        }

        @media print {
            body {
                background: white;
            }
            .form-section, .no-print, .header, .data-history, .close-preview {
                display: none !important;
            }
            .main-wrapper {
                grid-template-columns: 1fr !important;
            }
            .preview-section {
                display: block !important;
                padding: 0 !important;
                box-shadow: none !important;
            }
            .preview-header {
                display: none !important;
            }
            .kwitansi-preview {
                border: 1px solid #000;
                max-width: 100%;
            }
        }

        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }

        @keyframes fadeInDown {
            from {
                opacity: 0;
                transform: translateY(-20px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        @keyframes pulse {
            0% {
                transform: scale(1);
            }
            50% {
                transform: scale(1.05);
            }
            100% {
                transform: scale(1);
            }
        }

        .data-history {
            background: white;
            border-radius: 15px;
            padding: 20px;
            margin-top: 30px;
            box-shadow: 
                0 10px 20px rgba(0,0,0,0.2),
                0 0 0 1px rgba(255,140,0,0.1);
            position: relative;
            overflow: hidden;
        }
        
        .data-history::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 3px;
            background: linear-gradient(90deg, #ff8c00 0%, #007bff 50%, #ff8c00 100%);
        }
        
        .data-history h2 {
            color: #333;
            margin-bottom: 20px;
            padding-bottom: 10px;
            border-bottom: 3px solid #ff8c00;
        }

        .history-table {
            width: 100%;
            margin-top: 20px;
            border-collapse: collapse;
        }

        .history-table th {
            background: linear-gradient(135deg, #2d2d2d 0%, #1a1a1a 100%);
            color: #ff8c00;
            padding: 12px;
            text-align: left;
            font-size: 14px;
        }

        .history-table td {
            padding: 12px;
            border-bottom: 1px solid #e0e0e0;
            font-size: 14px;
        }

        .history-table tr:hover {
            background: #f9f9f9;
        }

        .btn-small {
            padding: 6px 12px;
            font-size: 13px;
            margin: 0 3px;
        }

        .export-import-buttons {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
        }

        .success-message {
            background: linear-gradient(135deg, #4CAF50 0%, #45a049 100%);
            color: white;
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 20px;
            text-align: center;
            animation: slideIn 0.5s ease;
        }

        .error-message {
            background: linear-gradient(135deg, #f44336 0%, #e53935 100%);
            color: white;
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 20px;
            text-align: center;
            animation: slideIn 0.5s ease;
        }

        .empty-state {
            text-align: center;
            padding: 40px;
            color: #999;
        }

        .empty-state svg {
            width: 60px;
            height: 60px;
            margin-bottom: 20px;
            opacity: 0.3;
        }

        small {
            display: block;
            margin-top: 5px;
            color: #666;
            font-size: 12px;
            font-style: italic;
        }

        .required-field {
            color: #f44336;
            font-weight: normal;
        }

        @media (max-width: 768px) {
            .header {
                flex-direction: column;
                text-align: center;
            }
            
            .header-text {
                text-align: center;
            }
            
            .header h1 {
                font-size: 1.8em;
            }
            
            .items-container {
                padding: 15px;
                min-width: auto;
            }
            
            .items-table {
                min-width: auto;
                overflow-x: auto;
            }
            
            .item-header, .item-row {
                grid-template-columns: 1fr;
                gap: 10px;
            }
            
            .item-header > div {
                padding: 5px;
                background: #f8f8f8;
                border-radius: 4px;
            }
            
            .item-row {
                border: 1px solid #e0e0e0;
                padding: 15px;
                margin-bottom: 15px;
            }
            
            .item-row input, .item-row button {
                margin-bottom: 10px;
            }
            
            .main-wrapper.with-preview {
                grid-template-columns: 1fr;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <div class="logo-container">
                <!-- For header, use logo image or fallback to SVG -->
                <img src="logo.png" alt="Toba Welder" class="logo-img" onerror="this.style.display='none'; this.nextElementSibling.style.display='block';">
                <svg class="star-logo" style="display:none;" viewBox="0 0 100 100">
                    <path class="star" d="M50 5 L61 39 L97 39 L69 61 L80 95 L50 73 L20 95 L31 61 L3 39 L39 39 Z"/>
                    <g class="welder-icon">
                        <circle cx="50" cy="40" r="8" fill="#ff8c00" opacity="0.9"/>
                        <rect x="47" y="45" width="6" height="15" fill="#1a1a1a"/>
                        <rect x="45" y="55" width="10" height="4" fill="#007bff"/>
                        <path d="M48 48 L52 48 L54 52 L46 52 Z" fill="#ff8c00"/>
                        <path d="M50 38 L50 35 M55 40 L58 38 M45 40 L42 38" stroke="#fff" stroke-width="2" stroke-linecap="round" opacity="0.8"/>
                    </g>
                </svg>
            </div>
            <div class="header-text">
                <center><h1>TOBA WELDER</h1></center>
                <center><p><h3>Pergola/Decking/Fencing</h3></p></center>
            </div>
        </div>

        <div id="successMessage" style="display: none;" class="success-message">
            ✔ Quotation generated successfully!
        </div>

        <div id="errorMessage" style="display: none;" class="error-message">
            ⚠ Error: <span id="errorText"></span>
        </div>

        <div class="main-wrapper form-only" id="mainWrapper">
            <!-- Form Section -->
            <div class="form-section" id="formSection">
                <h2>📋 Create New Quotation</h2>
                <form id="kwitansiForm">
                    <div class="form-group">
                        <label>Quote Number <span class="required-field">*</span>:</label>
                        <div class="nomor-group">
                            <input type="text" id="nomorPrefix" readonly style="background: #f0f0f0;">
                            <input type="text" id="nomorSuffix" placeholder="Number" required>
                        </div>
                        <small>Format: Year/Month/Day/Number (Must be unique)</small>
                    </div>

                    <div class="form-group">
                        <label>Date <span class="required-field">*</span>:</label>
                        <input type="date" id="tanggal" required>
                    </div>

                    <div class="form-group">
                        <label>Customer Name <span class="required-field">*</span>:</label>
                        <input type="text" id="customerName" placeholder="Enter customer name..." required>
                    </div>

                    <div class="form-group">
                        <label>Customer Address <span class="required-field">*</span>:</label>
                        <textarea id="customerAddress" placeholder="Enter complete address..." required rows="2"></textarea>
                    </div>

                    <div class="form-group">
                        <label>Phone:</label>
                        <input type="tel" id="telepon" placeholder="Customer phone number">
                    </div>

                    <div class="form-group">
                        <label>Email:</label>
                        <input type="email" id="email" placeholder="Customer email address">
                    </div>

                    <h3 style="margin: 25px 0 15px; color: #ff8c00; font-size: 18px;">📦 Services & Materials</h3>
                    <div class="items-container">
                        <div class="items-table">
                            <div class="item-header">
                                <div>Description</div>
                                <div style="text-align: center;">Qty</div>
                                <div style="text-align: right;">Price ($)</div>
                                <div style="text-align: right;">Total ($)</div>
                                <div style="text-align: center;">Action</div>
                            </div>
                            <div id="itemsList">
                                <div class="item-row">
                                    <input type="text" placeholder="e.g. Gate welding, Steel fabrication" class="item-desc">
                                    <input type="number" placeholder="1" class="item-qty" value="1" min="1" onchange="calculateItemTotal(this)">
                                    <input type="number" placeholder="0.00" class="item-price" step="0.01" min="0" onchange="calculateItemTotal(this)">
                                    <input type="text" placeholder="0.00" class="item-total" readonly>
                                    <button type="button" class="btn btn-remove" onclick="removeItem(this)">✕ Delete</button>
                                </div>
                            </div>
                        </div>
                        <button type="button" class="btn btn-add" onclick="addItem()">➕ Add Item</button>
                    </div>

                    <div class="form-group">
                        <label>Additional Notes (Optional):</label>
                        <textarea id="notes" placeholder="Payment terms, special instructions, or additional information..." rows="3"></textarea>
                    </div>

                    <div class="action-buttons">
                        <button type="submit" class="btn btn-primary" id="generateBtn">⚡ Generate Quotation</button>
                        <button type="button" class="btn btn-danger" onclick="resetForm()">🔄 Reset Form</button>
                    </div>
                </form>
            </div>

            <!-- Preview Section (Initially Hidden) -->
            <div class="preview-section" id="previewSection">
                <div class="preview-header">
                    <h2>📄 Quotation Preview</h2>
                    <button class="close-preview" onclick="closePreview()" title="Close Preview">✕</button>
                </div>
                <div id="kwitansiPreview" class="kwitansi-preview">
                    <!-- Preview content will be generated here -->
                </div>
                
                <div class="no-print">
                    <div class="action-buttons" id="previewButtons">
                        <!-- Dynamic buttons will be inserted here -->
                    </div>
                </div>
            </div>
        </div>

        <!-- History Section -->
        <div class="data-history">
            <h2>📊 Quotation History</h2>
            <div class="export-import-buttons">
                <button class="btn btn-success btn-small" onclick="exportData()">Export Data</button>
                <button class="btn btn-primary btn-small" onclick="importData()">Import Data</button>
                <input type="file" id="importFile" accept=".json" style="display: none;" onchange="handleImport(event)">
            </div>
            <table class="history-table">
                <thead>
                    <tr>
                        <th>Quote No.</th>
                        <th>Date</th>
                        <th>Customer</th>
                        <th>Total</th>
                        <th>Actions</th>
                    </tr>
                </thead>
                <tbody id="historyTable">
                    <tr>
                        <td colspan="5" class="empty-state">
                            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <path d="M9 13h6m-3-3v6m-9 1V7a2 2 0 012-2h6l2 2h6a2 2 0 012 2v8a2 2 0 01-2 2H5a2 2 0 01-2-2z"/>
                            </svg>
                            <p>No quotations yet</p>
                        </td>
                    </tr>
                </tbody>
            </table>
        </div>
    </div>

    <!-- Hidden PDF Template -->
    <div id="pdfTemplate" class="pdf-template">
        <!-- This will be populated when generating PDF -->
    </div>

    <script>
        // Company Fixed Data
        const companyData = {
            name: "Toba Welder",
            address: "49 Bloomfield Avenue, Maribyrnong 3032",
            abn: "49280241868",
            phone: "0431509279",
            email: "samosirbram1974@gmail.com",
            accountName: "SAMOSIR M",
            bsb: "014111",
            accountNumber: "798498599"
        };

        // Global state for view context
        let currentViewContext = 'generate'; // 'generate' or 'view'
        let currentViewIndex = null;

        // Initialize
        document.addEventListener('DOMContentLoaded', function() {
            const today = new Date().toISOString().split('T')[0];
            document.getElementById('tanggal').value = today;
            generateNomorPrefix();
            loadHistory();
            
            // Check if required libraries are loaded
            setTimeout(() => {
                if (!window.html2canvas) {
                    console.error('html2canvas library not loaded!');
                    alert('Warning: PDF generation library (html2canvas) not loaded. Please refresh the page.');
                }
                if (!window.jspdf) {
                    console.error('jsPDF library not loaded!');
                    alert('Warning: PDF generation library (jsPDF) not loaded. Please refresh the page.');
                }
            }, 2000); // Check after 2 seconds
        });

        // Generate Nomor Prefix
        function generateNomorPrefix() {
            const tanggal = document.getElementById('tanggal').value;
            if (tanggal) {
                const date = new Date(tanggal);
                const year = date.getFullYear();
                const month = String(date.getMonth() + 1).padStart(2, '0');
                const day = String(date.getDate()).padStart(2, '0');
                
                const prefix = `${year}/${month}/${day}/`;
                document.getElementById('nomorPrefix').value = prefix;
            }
        }

        // Update prefix when date changes
        document.getElementById('tanggal').addEventListener('change', generateNomorPrefix);

        // Calculate item total
        function calculateItemTotal(input) {
            const row = input.parentElement;
            const qty = parseFloat(row.querySelector('.item-qty').value) || 0;
            const price = parseFloat(row.querySelector('.item-price').value) || 0;
            const total = qty * price;
            row.querySelector('.item-total').value = total.toFixed(2);
        }

        // Add Item
        function addItem() {
            const itemsList = document.getElementById('itemsList');
            const newItem = document.createElement('div');
            newItem.className = 'item-row';
            newItem.innerHTML = `
                <input type="text" placeholder="e.g. Gate welding, Steel fabrication" class="item-desc">
                <input type="number" placeholder="1" class="item-qty" value="1" min="1" onchange="calculateItemTotal(this)">
                <input type="number" placeholder="0.00" class="item-price" step="0.01" min="0" onchange="calculateItemTotal(this)">
                <input type="text" placeholder="0.00" class="item-total" readonly>
                <button type="button" class="btn btn-remove" onclick="removeItem(this)">✕ Delete</button>
            `;
            itemsList.appendChild(newItem);
        }

        // Remove Item
        function removeItem(button) {
            const itemRows = document.querySelectorAll('.item-row');
            if (itemRows.length > 1) {
                button.parentElement.remove();
            } else {
                alert('At least one item is required!');
            }
        }

        // Show Error Message
        function showError(message) {
            const errorMsg = document.getElementById('errorMessage');
            const errorText = document.getElementById('errorText');
            errorText.textContent = message;
            errorMsg.style.display = 'block';
            setTimeout(() => {
                errorMsg.style.display = 'none';
            }, 5000);
        }

        // Check if Quote Number is Unique
        function isQuoteNumberUnique(quoteNumber, excludeIndex = -1) {
            const history = JSON.parse(localStorage.getItem('kwitansiHistory') || '[]');
            return !history.some((item, index) => index !== excludeIndex && item.nomorKwitansi === quoteNumber);
        }

        // Close Preview
        function closePreview() {
            document.getElementById('previewSection').classList.remove('active');
            document.getElementById('mainWrapper').classList.add('form-only');
            document.getElementById('mainWrapper').classList.remove('with-preview');
            document.getElementById('formSection').scrollIntoView({ behavior: 'smooth' });
            
            // Reset context
            currentViewContext = 'generate';
            currentViewIndex = null;
        }

        // Setup Preview Buttons Based on Context
        function setupPreviewButtons(context) {
            const buttonsContainer = document.getElementById('previewButtons');
            
            if (context === 'generate') {
                // Generate context: Save, Download PDF, Print
                buttonsContainer.innerHTML = `
                    <button class="btn btn-primary" onclick="saveToHistory()">💾 Save</button>
                    <button class="btn btn-primary" onclick="downloadCompactPDF()">📥 Download PDF</button>
                    <button class="btn btn-success" onclick="printKwitansi()">🖨️ Print</button>
                `;
            } else if (context === 'view') {
                // View from history context: Edit, Download PDF, Print
                buttonsContainer.innerHTML = `
                    <button class="btn btn-primary" onclick="editFromHistory(${currentViewIndex})">✏️ Edit</button>
                    <button class="btn btn-primary" onclick="downloadCompactPDF()">📥 Download PDF</button>
                    <button class="btn btn-success" onclick="printKwitansi()">🖨️ Print</button>
                `;
            }
        }

        // Form Submit
        document.getElementById('kwitansiForm').addEventListener('submit', function(e) {
            e.preventDefault();
            generateKwitansi();
        });

        // Generate Kwitansi
        function generateKwitansi(isCompact = false) {
            const nomorPrefix = document.getElementById('nomorPrefix').value;
            const nomorSuffix = document.getElementById('nomorSuffix').value;
            
            if (!nomorSuffix) {
                showError('Please enter a quote number!');
                return;
            }
            
            const nomorKwitansi = nomorPrefix + nomorSuffix;
            
            // Check for unique quote number
            if (!isQuoteNumberUnique(nomorKwitansi)) {
                showError(`Quote number ${nomorKwitansi} already exists! Please use a different number.`);
                document.getElementById('nomorSuffix').focus();
                return;
            }
            
            const tanggal = document.getElementById('tanggal').value;
            const customerName = document.getElementById('customerName').value;
            const customerAddress = document.getElementById('customerAddress').value;
            const telepon = document.getElementById('telepon').value;
            const email = document.getElementById('email').value;
            const notes = document.getElementById('notes').value;

            // Get items
            const items = [];
            let subtotal = 0;
            
            document.querySelectorAll('.item-row').forEach(row => {
                const desc = row.querySelector('.item-desc').value;
                const qty = parseFloat(row.querySelector('.item-qty').value) || 0;
                const price = parseFloat(row.querySelector('.item-price').value) || 0;
                
                if (desc && price > 0) {
                    const total = qty * price;
                    items.push({ desc, qty, price, total });
                    subtotal += total;
                }
            });

            if (items.length === 0) {
                showError('Please add at least one item!');
                return;
            }

            // Set context to generate
            currentViewContext = 'generate';
            currentViewIndex = null;

            // Generate preview
            showQuotationPreview({
                nomorKwitansi,
                tanggal,
                customerName,
                customerAddress,
                telepon,
                email,
                notes,
                items,
                subtotal
            });

            // Setup buttons for generate context
            setupPreviewButtons('generate');

            // Show success message
            const successMsg = document.getElementById('successMessage');
            successMsg.style.display = 'block';
            setTimeout(() => {
                successMsg.style.display = 'none';
            }, 3000);
        }

        // Show Quotation Preview (used by both generate and view)
        function showQuotationPreview(data) {
            const {
                nomorKwitansi,
                tanggal,
                customerName,
                customerAddress,
                telepon,
                email,
                notes,
                items,
                subtotal
            } = data;

            const gst = subtotal * 0.1; // 10% GST
            const grandTotal = subtotal + gst;

            // Determine if compact based on items count
            const useCompact = items.length <= 5;
            const previewClass = useCompact ? 'kwitansi-preview kwitansi-compact' : 'kwitansi-preview';

            // Show preview section
            document.getElementById('previewSection').classList.add('active');
            document.getElementById('mainWrapper').classList.remove('form-only');
            document.getElementById('mainWrapper').classList.add('with-preview');

            // Generate preview
            const preview = document.getElementById('kwitansiPreview');
            preview.className = previewClass;
            preview.innerHTML = `
                <div class="kwitansi-header">
                    <div class="logo-preview">
                        <img src="logo.png" alt="Toba Welder" style="width: 100%; height: 100%; object-fit: contain;">
                    </div>
                    <div class="company-name">${companyData.name}</div>
                    <div class="company-subtitle">Pergola/Decking/Fencing</div>
                    <div class="kwitansi-title">QUOTATION #${nomorKwitansi}</div>
                </div>

                <div class="kwitansi-info">
                    <div class="info-block">
                        <h4>FROM</h4>
                        <p><strong>${companyData.name}</strong></p>
                        <p>${companyData.address}</p>
                        <p>ABN: ${companyData.abn}</p>
                        <p>Phone: ${companyData.phone}</p>
                        <p>Email: ${companyData.email}</p>
                    </div>
                    <div class="info-block">
                        <h4>TO</h4>
                        <p><strong>${customerName}</strong></p>
                        <p>${customerAddress.replace(/\n/g, '<br>')}</p>
                        ${telepon ? `<p>Phone: ${telepon}</p>` : ''}
                        ${email ? `<p>Email: ${email}</p>` : ''}
                        <p style="margin-top: 8px;">
                            <strong>Date:</strong> ${formatDate(tanggal)}
                        </p>
                    </div>
                </div>

                <div class="kwitansi-items">
                    <table>
                        <thead>
                            <tr>
                                <th style="width: 8%;">No</th>
                                <th style="width: 42%;">Description</th>
                                <th style="width: 10%; text-align: center;">Qty</th>
                                <th style="width: 20%; text-align: right;">Price/Unit</th>
                                <th style="width: 20%; text-align: right;">Amount</th>
                            </tr>
                        </thead>
                        <tbody>
                            ${items.map((item, index) => `
                                <tr>
                                    <td>${index + 1}</td>
                                    <td>${item.desc}</td>
                                    <td style="text-align: center;">${item.qty}</td>
                                    <td style="text-align: right;">${formatCurrency(item.price)}</td>
                                    <td style="text-align: right;">${formatCurrency(item.total)}</td>
                                </tr>
                            `).join('')}
                        </tbody>
                    </table>
                </div>

                ${notes ? `
                <div class="kwitansi-notes">
                    <h5>Notes:</h5>
                    <p>${notes.replace(/\n/g, '<br>')}</p>
                </div>
                ` : ''}

                <div class="kwitansi-total">
                    <div class="total-row">
                        <span class="total-label">Subtotal:</span>
                        <span class="total-amount">${formatCurrency(subtotal)}</span>
                    </div>
                    <div class="total-row">
                        <span class="total-label">GST (10%):</span>
                        <span class="total-amount">${formatCurrency(gst)}</span>
                    </div>
                    <div class="total-row grand-total">
                        <span class="total-label">TOTAL (Including GST):</span>
                        <span class="total-amount">${formatCurrency(grandTotal)}</span>
                    </div>
                </div>

                <div class="account-info">
                    <h5>PAYMENT INFORMATION</h5>
                    <p>
                        Account Name: <strong>${companyData.accountName}</strong> | 
                        BSB: <strong>${companyData.bsb}</strong> | 
                        Account Number: <strong>${companyData.accountNumber}</strong>
                    </p>
                </div>

                <div class="kwitansi-footer" style="display: flex; justify-content: center;">
                    <div class="signature-box" style="max-width: 300px; text-align: center;">
                        <div style="width: 60px; height: 60px; margin: 0 auto 10px;">
                            <img src="logo.png" alt="Company Stamp" style="width: 100%; height: 100%; object-fit: contain;" 
                                onerror="this.style.display='none'; this.nextElementSibling.style.display='block';">
                            <svg viewBox="0 0 100 100" style="width: 60px; height: 60px; display: none;">
                                <path fill="#1a1a1a" stroke="#ff8c00" stroke-width="2" d="M50 5 L61 39 L97 39 L69 61 L80 95 L50 73 L20 95 L31 61 L3 39 L39 39 Z"/>
                            </svg>
                        </div>
                        <p>Authorized Welding Specialist</p>
                        <div class="signature-line">
                            <p>${companyData.name}</p>
                            <p style="font-size: 9px; margin-top: 5px;">ABN: ${companyData.abn}</p>
                        </div>
                    </div>
                </div>

                <p style="margin-top: 20px; font-size: 9px; text-align: center; color: #888;">
                    This quotation remains valid for 30 days from the date of issue. All welding work guaranteed to Australian Standards.
                </p>
            `;

            // Store current data for PDF generation
            window.currentQuotationData = data;

            // Scroll to preview
            preview.scrollIntoView({ behavior: 'smooth' });
        }

        // Format Currency (with commas)
        function formatCurrency(amount) {
            return amount.toFixed(2).replace(/\B(?=(\d{3})+(?!\d))/g, ",");
        }

        // Format Date
        function formatDate(dateString) {
            const options = { year: 'numeric', month: 'long', day: 'numeric' };
            return new Date(dateString).toLocaleDateString('en-AU', options);
        }

        // Create Compact PDF Template
        function createCompactPDFTemplate(data) {
            const {
                nomorKwitansi,
                tanggal,
                customerName,
                customerAddress,
                telepon,
                email,
                notes,
                items,
                subtotal
            } = data;

            const gst = subtotal * 0.1;
            const grandTotal = subtotal + gst;

            return `
                <div class="pdf-compact">
                    <div class="pdf-header">
                        <div class="pdf-logo">
                            <svg viewBox="0 0 100 100">
                                <path fill="#1a1a1a" stroke="#ff8c00" stroke-width="2" d="M50 5 L61 39 L97 39 L69 61 L80 95 L50 73 L20 95 L31 61 L3 39 L39 39 Z"/>
                            </svg>
                        </div>
                        <div class="pdf-company">${companyData.name}</div>
                        <div class="pdf-subtitle">Pergola/Decking/Fencing</div>
                        <div class="pdf-quote-no">QUOTATION #${nomorKwitansi}</div>
                    </div>

                    <div class="pdf-info">
                        <div class="pdf-info-block">
                            <h4>FROM</h4>
                            <p><strong>${companyData.name}</strong></p>
                            <p>${companyData.address}</p>
                            <p>ABN: ${companyData.abn}</p>
                            <p>Phone: ${companyData.phone}</p>
                            <p>Email: ${companyData.email}</p>
                        </div>
                        <div class="pdf-info-block">
                            <h4>TO</h4>
                            <p><strong>${customerName}</strong></p>
                            <p>${customerAddress.replace(/\n/g, '<br>')}</p>
                            ${telepon ? `<p>Phone: ${telepon}</p>` : ''}
                            ${email ? `<p>Email: ${email}</p>` : ''}
                            <p><strong>Date:</strong> ${formatDate(tanggal)}</p>
                        </div>
                    </div>

                    <table>
                        <thead>
                            <tr>
                                <th style="width: 8%;">No</th>
                                <th style="width: 42%;">Description</th>
                                <th style="width: 10%; text-align: center;">Qty</th>
                                <th style="width: 20%; text-align: right;">Price</th>
                                <th style="width: 20%; text-align: right;">Amount</th>
                            </tr>
                        </thead>
                        <tbody>
                            ${items.map((item, index) => `
                                <tr>
                                    <td>${index + 1}</td>
                                    <td>${item.desc}</td>
                                    <td style="text-align: center;">${item.qty}</td>
                                    <td style="text-align: right;">$${formatCurrency(item.price)}</td>
                                    <td style="text-align: right;">$${formatCurrency(item.total)}</td>
                                </tr>
                            `).join('')}
                        </tbody>
                    </table>

                    ${notes ? `
                    <div class="pdf-notes">
                        <strong>NOTES:</strong><br>
                        ${notes.replace(/\n/g, '<br>')}
                    </div>
                    ` : ''}

                    <div class="pdf-total">
                        <div class="pdf-total-row">
                            <span class="pdf-total-label">Subtotal:</span>
                            <span>$${formatCurrency(subtotal)}</span>
                        </div>
                        <div class="pdf-total-row">
                            <span class="pdf-total-label">GST (10%):</span>
                            <span>$${formatCurrency(gst)}</span>
                        </div>
                        <div class="pdf-total-row pdf-grand-total">
                            <span class="pdf-total-label">TOTAL:</span>
                            <span>$${formatCurrency(grandTotal)}</span>
                        </div>
                    </div>

                    <div class="pdf-payment">
                        <strong>PAYMENT INFO:</strong> 
                        ${companyData.accountName} | BSB: ${companyData.bsb} | Acc: ${companyData.accountNumber}
                    </div>

                    <div class="pdf-signatures-single">
                        <div class="pdf-signature-box-center">
                            <div class="pdf-logo-stamp">
                                <svg viewBox="0 0 100 100" style="width: 40px; height: 40px;">
                                    <path fill="#1a1a1a" stroke="#ff8c00" stroke-width="2" d="M50 5 L61 39 L97 39 L69 61 L80 95 L50 73 L20 95 L31 61 L3 39 L39 39 Z"/>
                                </svg>
                            </div>
                            <p style="margin-top: 5px; font-weight: bold;">Authorized Welding Specialist</p>
                            <div class="pdf-signature-line">
                                ${companyData.name}
                            </div>
                            <p style="font-size: 7pt; margin-top: 3px;">ABN: ${companyData.abn}</p>
                        </div>
                    </div>

                    <div class="pdf-footer">
                        Valid for 30 days from issue date. All work guaranteed to Australian Standards.
                    </div>
                </div>
            `;
        }

        // New Compact PDF Download Function
        async function downloadCompactPDF() {
        const data = window.currentQuotationData || getCurrentFormData();
        
        if (!data) {
            alert('Please generate a quotation first!');
            return;
        }
        
        let button = null;
        const allButtons = document.querySelectorAll('button');
        allButtons.forEach(btn => {
            if (btn.textContent.includes('Download PDF')) {
                button = btn;
            }
        });
        
        try {
            let originalText = '';
            if (button) {
                originalText = button.textContent;
                button.textContent = 'Generating PDF...';
                button.disabled = true;
            }
            
            if (!window.html2canvas || !window.jspdf) {
                throw new Error('PDF libraries not loaded. Please refresh the page.');
            }
            
            // Create compact template
            const pdfTemplate = document.getElementById('pdfTemplate');
            pdfTemplate.innerHTML = createCompactPDFTemplate(data);
            
            // PENTING: Hapus padding dari container untuk hasil yang lebih akurat
            pdfTemplate.style.display = 'block';
            pdfTemplate.style.position = 'fixed';
            pdfTemplate.style.left = '0';
            pdfTemplate.style.top = '0';
            pdfTemplate.style.width = '95mm';  // Kurangi dari 105mm
            pdfTemplate.style.background = 'white';
            pdfTemplate.style.padding = '0';  // Hapus padding
            pdfTemplate.style.zIndex = '-1';
            
            // Generate canvas
            const canvas = await html2canvas(pdfTemplate.firstElementChild, {
                scale: 2.5,
                logging: false,
                useCORS: true,
                allowTaint: true,
                backgroundColor: '#ffffff'
            });
            
            // Hide template
            pdfTemplate.style.display = 'none';
            pdfTemplate.innerHTML = '';
            
            // Create PDF
            const { jsPDF } = window.jspdf;
            const pdf = new jsPDF({
                orientation: 'p',
                unit: 'mm',
                format: [105, 148.5]
            });
            
            const imgData = canvas.toDataURL('image/png', 1.0);
            
            // Kalkulasi dengan margin seimbang
            const pageWidth = 105;
            const pageHeight = 148.5;
            const margin = 5;
            
            // Hitung ukuran maksimal yang bisa digunakan
            const maxWidth = pageWidth - (margin * 2);
            const maxHeight = pageHeight - (margin * 2);
            
            // Hitung aspect ratio dari canvas
            const canvasRatio = canvas.width / canvas.height;
            const pageRatio = maxWidth / maxHeight;
            
            let imgWidth, imgHeight;
            
            // Fit to page dengan mempertahankan aspect ratio
            if (canvasRatio > pageRatio) {
                // Canvas lebih lebar, fit ke width
                imgWidth = maxWidth;
                imgHeight = imgWidth / canvasRatio;
            } else {
                // Canvas lebih tinggi, fit ke height
                imgHeight = maxHeight;
                imgWidth = imgHeight * canvasRatio;
            }
            
            // Center dengan sempurna
            const xOffset = (pageWidth - imgWidth) / 2;
            const yOffset = (pageHeight - imgHeight) / 2;
            
            // Add image
            pdf.addImage(imgData, 'PNG', xOffset, yOffset, imgWidth, imgHeight);
            
            // Generate filename
            const quoteNo = data.nomorKwitansi.replace(/\//g, '-');
            const cleanCustomerName = (data.customerName || 'Customer').replace(/[^a-zA-Z0-9]/g, '').substring(0, 20);
            const filename = `Quote_${quoteNo}_${cleanCustomerName}.pdf`;
            
            pdf.save(filename);
            
            if (button) {
                button.textContent = originalText;
                button.disabled = false;
            }
            
            console.log('PDF generated successfully:', filename);
            
        } catch (error) {
            console.error('PDF Generation Error:', error);
            alert(`Failed to generate PDF: ${error.message}`);
            
            const pdfTemplate = document.getElementById('pdfTemplate');
            pdfTemplate.style.display = 'none';
            pdfTemplate.innerHTML = '';
            
            if (button) {
                button.textContent = '📥 Download PDF';
                button.disabled = false;
            }
        }
    }

        // Get current form data (helper function)
        function getCurrentFormData() {
            const nomorPrefix = document.getElementById('nomorPrefix').value;
            const nomorSuffix = document.getElementById('nomorSuffix').value;
            
            if (!nomorSuffix) return null;
            
            const items = [];
            let subtotal = 0;
            
            document.querySelectorAll('.item-row').forEach(row => {
                const desc = row.querySelector('.item-desc').value;
                const qty = parseFloat(row.querySelector('.item-qty').value) || 0;
                const price = parseFloat(row.querySelector('.item-price').value) || 0;
                
                if (desc && price > 0) {
                    const total = qty * price;
                    items.push({ desc, qty, price, total });
                    subtotal += total;
                }
            });
            
            if (items.length === 0) return null;
            
            return {
                nomorKwitansi: nomorPrefix + nomorSuffix,
                tanggal: document.getElementById('tanggal').value,
                customerName: document.getElementById('customerName').value,
                customerAddress: document.getElementById('customerAddress').value,
                telepon: document.getElementById('telepon').value,
                email: document.getElementById('email').value,
                notes: document.getElementById('notes').value,
                items: items,
                subtotal: subtotal
            };
        }

        // Print function
        function printKwitansi() {
            window.print();
        }

        // Reset Form
        function resetForm() {
            if (confirm('Are you sure you want to reset the form?')) {
                document.getElementById('kwitansiForm').reset();
                generateNomorPrefix();
                document.getElementById('itemsList').innerHTML = `
                    <div class="item-row">
                        <input type="text" placeholder="e.g. Gate welding, Steel fabrication" class="item-desc">
                        <input type="number" placeholder="1" class="item-qty" value="1" min="1" onchange="calculateItemTotal(this)">
                        <input type="number" placeholder="0.00" class="item-price" step="0.01" min="0" onchange="calculateItemTotal(this)">
                        <input type="text" placeholder="0.00" class="item-total" readonly>
                        <button type="button" class="btn btn-remove" onclick="removeItem(this)">✕ Delete</button>
                    </div>
                `;
                closePreview();
            }
        }

        // Save to History
        function saveToHistory() {
            const data = window.currentQuotationData || getCurrentFormData();
            
            if (!data) {
                showError('No quotation data to save!');
                return;
            }
            
            // Check for unique quote number before saving
            if (!isQuoteNumberUnique(data.nomorKwitansi)) {
                showError(`Cannot save: Quote number ${data.nomorKwitansi} already exists in history!`);
                return;
            }
            
            // Add timestamp
            data.timestamp = new Date().toISOString();
            
            // Get existing history
            let history = JSON.parse(localStorage.getItem('kwitansiHistory') || '[]');
            history.unshift(data);
            
            // Keep only last 100 records
            if (history.length > 100) {
                history = history.slice(0, 100);
            }

            localStorage.setItem('kwitansiHistory', JSON.stringify(history));
            loadHistory();
            
            // Success message
            const successMsg = document.getElementById('successMessage');
            successMsg.textContent = '✔ Quotation saved successfully!';
            successMsg.style.display = 'block';
            setTimeout(() => {
                successMsg.style.display = 'none';
                successMsg.textContent = '✔ Quotation generated successfully!';
            }, 3000);
        }

        // Load History
        function loadHistory() {
            const history = JSON.parse(localStorage.getItem('kwitansiHistory') || '[]');
            const tbody = document.getElementById('historyTable');
            
            if (history.length === 0) {
                tbody.innerHTML = `
                    <tr>
                        <td colspan="5" class="empty-state">
                            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <path d="M9 13h6m-3-3v6m-9 1V7a2 2 0 012-2h6l2 2h6a2 2 0 012 2v8a2 2 0 01-2 2H5a2 2 0 01-2-2z"/>
                            </svg>
                            <p>No quotations yet</p>
                        </td>
                    </tr>
                `;
                return;
            }

            tbody.innerHTML = history.map((item, index) => {
                const total = (item.subtotal || 0) * 1.1; // Add GST

                return `
                    <tr>
                        <td><strong>${item.nomorKwitansi}</strong></td>
                        <td>${formatDate(item.tanggal)}</td>
                        <td>${item.customerName || 'N/A'}</td>
                        <td><strong>$${formatCurrency(total)}</strong></td>
                        <td>
                            <button class="btn btn-success btn-small" onclick="viewFromHistory(${index})" title="View Only">👁️ View</button>
                            <button class="btn btn-primary btn-small" onclick="editFromHistory(${index})" title="Edit as New">✏️ Edit</button>
                            <button class="btn btn-danger btn-small" onclick="deleteFromHistory(${index})" title="Delete">🗑️ Delete</button>
                        </td>
                    </tr>
                `;
            }).join('');
        }

        // View from History
        function viewFromHistory(index) {
            const history = JSON.parse(localStorage.getItem('kwitansiHistory') || '[]');
            const data = history[index];
            
            if (data) {
                // Set context to view
                currentViewContext = 'view';
                currentViewIndex = index;
                
                // Show preview
                showQuotationPreview(data);
                
                // Setup buttons for view context
                setupPreviewButtons('view');
                
                // Scroll to preview
                document.getElementById('kwitansiPreview').scrollIntoView({ behavior: 'smooth' });
            }
        }
        
        // Edit from History
        function editFromHistory(index) {
            const history = JSON.parse(localStorage.getItem('kwitansiHistory') || '[]');
            const data = history[index];
            
            if (!data && index === undefined && currentViewIndex !== null) {
                index = currentViewIndex;
                data = history[index];
            }
            
            if (data) {
                alert('Note: This will copy the data as a new quotation. Please change the quote number to avoid duplicates.');
                
                // Parse nomor kwitansi
                const parts = data.nomorKwitansi.split('/');
                const prefix = parts.slice(0, -1).join('/') + '/';
                
                // Set form values
                document.getElementById('tanggal').value = data.tanggal;
                document.getElementById('nomorPrefix').value = prefix;
                document.getElementById('nomorSuffix').value = '';
                document.getElementById('customerName').value = data.customerName || '';
                document.getElementById('customerAddress').value = data.customerAddress || '';
                document.getElementById('telepon').value = data.telepon || '';
                document.getElementById('email').value = data.email || '';
                document.getElementById('notes').value = data.notes || '';
                
                // Clear existing items
                document.getElementById('itemsList').innerHTML = '';
                
                // Add items
                data.items.forEach(item => {
                    const newItem = document.createElement('div');
                    newItem.className = 'item-row';
                    const total = (parseFloat(item.qty) || 1) * (parseFloat(item.price) || 0);
                    newItem.innerHTML = `
                        <input type="text" placeholder="e.g. Gate welding, Steel fabrication" class="item-desc" value="${item.desc}">
                        <input type="number" placeholder="1" class="item-qty" value="${item.qty}" min="1" onchange="calculateItemTotal(this)">
                        <input type="number" placeholder="0.00" class="item-price" step="0.01" min="0" value="${item.price}" onchange="calculateItemTotal(this)">
                        <input type="text" placeholder="0.00" class="item-total" readonly value="${total.toFixed(2)}">
                        <button type="button" class="btn btn-remove" onclick="removeItem(this)">✕ Delete</button>
                    `;
                    document.getElementById('itemsList').appendChild(newItem);
                });
                
                // Close preview if open
                closePreview();
                
                // Focus on quote number suffix
                document.getElementById('nomorSuffix').focus();
                document.getElementById('nomorSuffix').style.borderColor = '#ff8c00';
                
                // Show info message
                const successMsg = document.getElementById('successMessage');
                successMsg.textContent = '⚠️ Please enter a new unique quote number to continue';
                successMsg.style.background = 'linear-gradient(135deg, #ff9800 0%, #f57c00 100%)';
                successMsg.style.display = 'block';
                setTimeout(() => {
                    successMsg.style.display = 'none';
                    successMsg.style.background = '';
                }, 5000);
                
                // Scroll to form
                document.getElementById('formSection').scrollIntoView({ behavior: 'smooth' });
            }
        }

        // Delete from History
        function deleteFromHistory(index) {
            if (confirm('Are you sure you want to delete this quotation?')) {
                let history = JSON.parse(localStorage.getItem('kwitansiHistory') || '[]');
                history.splice(index, 1);
                localStorage.setItem('kwitansiHistory', JSON.stringify(history));
                loadHistory();
            }
        }

        // Export Data
        function exportData() {
            const history = localStorage.getItem('kwitansiHistory') || '[]';
            const dataStr = "data:text/json;charset=utf-8," + encodeURIComponent(history);
            const downloadAnchor = document.createElement('a');
            downloadAnchor.setAttribute("href", dataStr);
            downloadAnchor.setAttribute("download", `quotations_backup_${new Date().getTime()}.json`);
            document.body.appendChild(downloadAnchor);
            downloadAnchor.click();
            downloadAnchor.remove();
        }

        // Import Data
        function importData() {
            document.getElementById('importFile').click();
        }

        // Handle Import
        function handleImport(event) {
            const file = event.target.files[0];
            if (file) {
                const reader = new FileReader();
                reader.onload = function(e) {
                    try {
                        const data = JSON.parse(e.target.result);
                        if (Array.isArray(data)) {
                            localStorage.setItem('kwitansiHistory', JSON.stringify(data));
                            loadHistory();
                            alert('Data imported successfully!');
                        } else {
                            alert('Invalid file format!');
                        }
                    } catch (err) {
                        alert('Error importing data: ' + err.message);
                    }
                };
                reader.readAsText(file);
            }
        }
    </script>
</body>
</html>
